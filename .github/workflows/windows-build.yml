name: Qt6 CI

on:
  push:
    branches: [ "use_qt5" ]
  pull_request:
    branches: [ "use_qt5" ]

jobs:
  build:
    runs-on: self-hosted
    strategy:
      matrix:
        platform: [windows-latest]

    env:
      ROOT_DIR: ${{ github.workspace }}
      CONFIG: Release

    steps:
    - uses: actions/checkout@v4

    - name: Ensure clang-format
      shell: pwsh
      run: |
        if (-not (Get-Command clang-format -ErrorAction SilentlyContinue)) {
            if (Get-Command choco -ErrorAction SilentlyContinue) {
                choco install llvm --version=14.0.6 -y --no-progress
            } else {
                throw "clang-format not found. Install LLVM clang-format 14 on the runner."
            }
        }

    - name: Check formatting
      shell: pwsh
      run: ./scripts/check-format.ps1

    - name: Install Boost
      uses: MarkusJx/install-boost@v2.4.5
      id: install-boost
      with:
         boost_version: 1.89.0
         platform_version: 2019
         toolset: msvc
         
    - name: Install Qt6
      uses: jurplel/install-qt-action@v3
      id: install-qt
      with:
        aqtversion: '==3.1.*'
        version: '6.9.2'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2022_64'
        tools: 'tools_cmake'
        #archives: 'qtxmlpatterns qttranslation qtbase'

    - name: Init variables
      shell: cmd
      run: |
        if defined Qt6_DIR (
          set "QT_ROOT=%Qt6_DIR%"
        ) else if defined Qt5_DIR (
          set "QT_ROOT=%Qt5_DIR%"
        ) else if defined QT_ROOT_DIR (
          set "QT_ROOT=%QT_ROOT_DIR%"
        ) else (
          echo Qt installation path not found.
          exit /b 1
        )
        echo set "IPPONBOARD_ROOT_DIR=${{ env.ROOT_DIR }}" > ${{ env.ENV_CFG }}
        echo set "QTDIR=%QT_ROOT%" >> ${{ env.ENV_CFG }}
        echo set "BOOST_DIR=${{ env.BOOST_DIR }}" >> ${{ env.ENV_CFG }}
      env:
        ENV_CFG: ${{ github.workspace }}/env_cfg.bat
        BOOST_DIR: ${{ steps.install-boost.outputs.BOOST_ROOT }}

    - name: Create version info
      shell: cmd
      run: scripts/create-versioninfo.cmd ${{ env.ROOT_DIR }}/base

    - name: Create makefile
      shell: cmd
      run: cmake -S "${{ env.ROOT_DIR }}" -B "_build/Ipponboard" -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=${{env.CONFIG}}

    - name: Build Tests
      shell: cmd
      run: cmake --build "_build/Ipponboard" --config ${{env.CONFIG}} --target IpponboardTest

    - name: Run tests
      shell: cmd
      continue-on-error: true
      run: |
        set QT_QPA_PLATFORM=offscreen
        set QT_LOGGING_RULES=qt.multimedia.symbolsresolver=false
        set QT_QPA_PLATFORM_PLUGIN_PATH=%Qt6_DIR%\plugins\platforms
        if not defined QT_QPA_FONTDIR set QT_QPA_FONTDIR=%WINDIR%\Fonts
        set IPPONBOARD_ENABLE_NETWORK_TESTS=0
        cd ./_bin/Test-${{env.CONFIG}}
        ./IpponboardTest.exe

    - name: Build Ipponboard
      shell: cmd
      run: cmake --build "_build/Ipponboard" --config ${{env.CONFIG}} --target Ipponboard
  
